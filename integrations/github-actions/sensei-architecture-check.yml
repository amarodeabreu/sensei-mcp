name: Sensei Architecture Check

# Run on every push to validate against established architectural patterns

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  workflow_dispatch:

jobs:
  architecture-validation:
    name: Validate Architecture Decisions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Sensei MCP
        run: |
          pip install sensei-mcp

      - name: Check consistency with past decisions
        run: |
          python << 'EOF'
          import subprocess
          import json

          # Get session summary from Sensei
          # This would use the check_consistency tool

          print("ðŸŽ­ Checking architectural consistency with Sensei...")

          # Example: Check if changes align with past decisions
          # In real implementation, this would call:
          # check_consistency(
          #   session_id="my-project",
          #   proposed_change="Summary of git diff"
          # )

          # For demo purposes:
          result = {
              "consistent": True,
              "violations": [],
              "suggestions": [
                  "Consider documenting this pattern in session decisions"
              ]
          }

          if result["consistent"]:
              print("âœ… Changes are consistent with architectural decisions")
          else:
              print("âŒ Potential inconsistencies detected:")
              for violation in result["violations"]:
                  print(f"  - {violation}")
              exit(1)

          if result["suggestions"]:
              print("\nðŸ’¡ Suggestions:")
              for suggestion in result["suggestions"]:
                  print(f"  - {suggestion}")

          EOF

      - name: Analyze git changes with Sensei
        run: |
          python << 'EOF'
          # Use Sensei's analyze_changes() tool
          # This identifies relevant contexts from staged changes

          print("ðŸ” Analyzing changes with Sensei MCP...")

          # In real implementation:
          # from sensei_mcp.server import analyze_changes
          # summary = analyze_changes(project_root=".")

          # Example output:
          print("ðŸ“Š Change Summary:")
          print("  - 5 files modified")
          print("  - Contexts detected: ARCHITECTURAL, SECURITY")
          print("  - Recommended personas: pragmatic-architect, security-sentinel")

          EOF

      - name: Generate architecture report
        run: |
          python << 'EOF'
          import os

          # Generate report using export_session_summary
          print("ðŸ“‹ Generating architecture report...")

          report = """
          # Architecture Health Report

          **Session:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}

          ## Active Constraints
          - Use microservices for new services
          - All APIs must use OpenAPI specs
          - Database changes require migration scripts

          ## Recent Decisions
          1. **Adopted Event-Driven Architecture** (2025-01-20)
             - Rationale: Improves scalability and decoupling
             - Impact: All new features should emit events

          2. **Standardized on PostgreSQL** (2025-01-15)
             - Rationale: Better JSON support, community
             - Impact: No new MySQL dependencies

          ## Recommendations
          - âœ… Code aligns with established patterns
          - ðŸ’¡ Consider adding integration tests for new event handlers
          - ðŸ’¡ Update OpenAPI spec for new endpoints

          ---
          *Generated by Sensei MCP*
          """

          with open("architecture_report.md", "w") as f:
              f.write(report)

          print("âœ… Report generated: architecture_report.md")
          EOF

      - name: Upload architecture report
        uses: actions/upload-artifact@v4
        with:
          name: architecture-report
          path: architecture_report.md
          retention-days: 90

      - name: Fail on violations
        run: |
          # This step would fail the workflow if critical violations are found
          # For now, just informational
          echo "âœ… No critical violations detected"

# Configuration:
# Set these as repository variables or in your workflow
env:
  SENSEI_SESSION_ID: ${{ github.repository }}
  SENSEI_PROJECT_ROOT: ${{ github.workspace }}
